@model ModuloWeb1.Models.OrdenCompraViewModel
@{
    ViewData["Title"] = "Nueva Orden de Compra";
}

<div class="container mt-4">
    <div class="card shadow-lg p-4">
        <h2 class="text-center text-primary mb-4">
             Orden de Compra
        </h2>

        <form asp-action="Crear" method="post">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Proveedor:</label>
                    <select name="idProveedor" class="form-select" required>
                        <option value="">Seleccione un proveedor</option>
                        @foreach (var p in ViewBag.Proveedores)
                        {
                            <option value="@p.Id">@p.Nombre - @p.Direccion</option>
                        }
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Condiciones de pago:</label>
                    <input type="text" name="condiciones" class="form-control" value="30 dÃ­as" />
                </div>
            </div>

            <hr />
            <h4 class="text-secondary">ðŸ›’ Productos</h4>

            <div id="productos" class="mb-3">
                <div class="row g-3 align-items-center mb-2 detalle border-bottom pb-2">
                    <div class="col-md-4">
                        <label class="form-label">Producto</label>
                        <select name="idProducto" class="form-select producto-select" onchange="actualizarPrecio(this)">
                            <option value="">Seleccione un producto</option>
                            @foreach (var pr in ViewBag.Productos)
                            {
                                <option value="@pr.Id" data-precio="@pr.Precio">@pr.Nombre</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Cantidad</label>
                        <input type="number" name="cantidad" class="form-control cantidad-input" min="1" value="1" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Precio</label>
                        <input type="text" name="precio" class="form-control precio-input" readonly />
                    </div>
                </div>
            </div>

            <button type="button" class="btn btn-outline-primary mb-3" onclick="agregarFila()">
                 Agregar otro producto
            </button>

            <div class="text-end fw-bold fs-5 mb-3">
                Total: $<span id="total">0.00</span>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-success px-4"> Generar Orden</button>
            </div>
        </form>

        @if (ViewBag.Mensaje != null)
        {
            <div class="alert alert-success text-center mt-4">
                @ViewBag.Mensaje
            </div>
        }
    </div>
</div>

<script>
    function agregarFila() {
        const div = document.createElement("div");
        div.className = "row g-3 align-items-center mb-2 detalle border-bottom pb-2";
        div.innerHTML = document.querySelector(".detalle").innerHTML;
        document.getElementById("productos").appendChild(div);
    }

    function actualizarPrecio(select) {
        const precio = select.options[select.selectedIndex].getAttribute("data-precio");
        const fila = select.closest(".detalle");
        fila.querySelector(".precio-input").value = precio;
        recalcularTotal();
    }

    document.addEventListener("input", function (e) {
        if (e.target.classList.contains("cantidad-input")) {
            recalcularTotal();
        }
    });

    function recalcularTotal() {
        let total = 0;
        document.querySelectorAll(".detalle").forEach(fila => {
            const precio = parseFloat(fila.querySelector(".precio-input").value || 0);
            const cantidad = parseInt(fila.querySelector(".cantidad-input").value || 0);
            total += precio * cantidad;
        });
        document.getElementById("total").innerText = total.toFixed(2);
    }
</script>
